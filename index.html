<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PowerNexus 智慧能源戰略中樞</title>

<script src="https://cdn.tailwindcss.com"></script>

<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "prop-types": "https://esm.sh/prop-types@15.8.1",
    "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom,prop-types",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react"
  }
}
</script>

<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background-color: #0f172a;
  height: 100%;
  width: 100%;
  padding-top: env(safe-area-inset-top, 12px);
  box-sizing: border-box;
}
#root {
  min-height: calc(100vh - env(safe-area-inset-top, 12px));
  width: 100%;
}
header { padding-top: 6px; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #1e293b; }
::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #64748b; }
</style>
</head>

<body>
<div id="root" class="flex items-center justify-center text-slate-500">
  系統啟動中 (System Initializing)...
</div>

<script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import {
  AreaChart, Area, Line, XAxis, YAxis,
  CartesianGrid, Tooltip, Legend,
  ResponsiveContainer, ReferenceLine
} from 'recharts';
import {
  Zap, BatteryCharging, TrendingUp,
  ShieldCheck, Settings, ExternalLink,
  Activity, DollarSign
} from 'lucide-react';

/* ===== 初始資料 ===== */
const MOCK_TAIPOWER_DATA = {
  reserveMargin: "—",
  operatingReserve: "—",
  lightColor: "Gray",
  load: "—",
  timestamp: "尚未同步"
};

/* ===== 備轉燈號規則（台電標準）===== */
function lightColorFromMargin(m) {
  const v = Number(m);
  if (isNaN(v)) return 'Gray';
  if (v >= 10) return 'Green';
  if (v >= 6) return 'Yellow';
  if (v >= 2) return 'Orange';
  return 'Red';
}

/* ===== 卡片元件 ===== */
const Card = ({ title, children }) => (
  <div className="bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-lg">
    <h3 className="text-slate-400 text-sm font-medium mb-3 flex items-center gap-2">
      {title}
    </h3>
    {children}
  </div>
);

/* ===== 主程式 ===== */
function PowerNexusDashboard() {

const [taipowerStatus, setTaipowerStatus] = useState(MOCK_TAIPOWER_DATA);
const [currentTime, setCurrentTime] = useState(new Date());

/* ===== 台電等級同步（只用 Open Data，無 fallback）===== */
useEffect(() => {
  let mounted = true;

  async function fetchTaipower() {
    try {
      const csvUrl =
        'https://data.taipower.com.tw/OpData/%E6%AF%8F%E6%97%A5%E5%82%99%E8%BD%89%E5%AE%B9%E9%87%8F%E7%8E%87_%E5%B0%96%E5%B3%B0_%E6%9C%AC%E5%B9%B4.csv';

      const res = await fetch(csvUrl);
      if (!res.ok) throw new Error('OpenData fetch failed');

      const text = await res.text();
      const rows = text.trim().split(/\r?\n/).filter(Boolean);
      if (rows.length < 2) throw new Error('No data');

      const header = rows[0].split(',');
      const latest = rows[rows.length - 1].split(',');

      const marginIdx = header.findIndex(h => h.includes('備轉容量率'));
      const reserveIdx = header.findIndex(h => h.includes('備轉容量'));

      const margin = latest[marginIdx].replace('%', '').trim();
      const reserve = reserveIdx >= 0 ? latest[reserveIdx].trim() : '—';

      if (mounted) {
        setTaipowerStatus({
          reserveMargin: Number(margin).toFixed(2),
          operatingReserve: reserve,
          lightColor: lightColorFromMargin(margin),
          load: '—',
          timestamp: new Date().toLocaleString()
        });
      }
    } catch (e) {
      if (mounted) {
        setTaipowerStatus({
          reserveMargin: '—',
          operatingReserve: '—',
          lightColor: 'Gray',
          load: '—',
          timestamp: '台電資料暫不可用'
        });
      }
    }
  }

  fetchTaipower();
  const timer = setInterval(fetchTaipower, 10 * 60 * 1000);
  return () => { mounted = false; clearInterval(timer); };
}, []);

/* ===== 時鐘 ===== */
useEffect(() => {
  const t = setInterval(() => setCurrentTime(new Date()), 1000);
  return () => clearInterval(t);
}, []);

const getLightClass = (c) => ({
  Green: 'bg-emerald-500',
  Yellow: 'bg-yellow-500',
  Orange: 'bg-orange-500',
  Red: 'bg-red-600',
  Gray: 'bg-slate-500'
}[c] || 'bg-slate-500');

return (
<div className="min-h-screen bg-slate-900 text-slate-100 p-6">

<header className="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
  <div className="flex items-center gap-3">
    <div className="bg-cyan-600 p-2 rounded-lg">
      <Zap size={28} className="text-white"/>
    </div>
    <div>
      <h1 className="text-2xl font-bold text-cyan-400">PowerNexus</h1>
      <p className="text-xs text-slate-400">智慧能源戰略中樞</p>
    </div>
  </div>
  <div className="text-right font-mono text-cyan-400">
    {currentTime.toLocaleTimeString()}
  </div>
</header>

<Card title={<><Activity size={16}/> 台電系統同步</>}>

<div className="flex flex-col md:flex-row justify-between items-center gap-6">

  <div className="flex items-center gap-4">
    <div className={`w-16 h-16 rounded-full flex items-center justify-center ${getLightClass(taipowerStatus.lightColor)}`}>
      <span className="font-bold text-white">{taipowerStatus.lightColor}</span>
    </div>
    <div>
      <div className="text-slate-400 text-sm">備轉容量率</div>
      <div className="text-4xl font-bold font-mono">{taipowerStatus.reserveMargin}%</div>
      <div className="text-xs text-slate-500">更新時間：{taipowerStatus.timestamp}</div>
    </div>
  </div>

  <!-- 查證按鈕 + tooltip -->
  <div className="relative group">
    <a
      href="https://data.taipower.com.tw/"
      target="_blank"
      rel="noopener noreferrer"
      className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md text-sm font-medium"
    >
      <ExternalLink size={16}/>
      台電官網查證
    </a>

    <div className="absolute right-0 mt-2 w-max
                    bg-slate-800 text-xs text-slate-200
                    px-3 py-2 rounded shadow-lg
                    opacity-0 group-hover:opacity-100
                    transition pointer-events-none">
      資料來源：台電開放資料平台<br/>
      與官網公布數值同步
    </div>
  </div>

</div>
</Card>

</div>
);
}

/* ===== 掛載 ===== */
const root = createRoot(document.getElementById('root'));
root.render(<PowerNexusDashboard />);
</script>
</body>
</html>
